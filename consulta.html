<!DOCTYPE html>
<!-- =======================================================================
 * üìÑ consulta.html ‚Äì Interfaz de Aprobaci√≥n (NASE 2026)
 * ----------------------------------------------------------------------
/**
 * @summary Dashboard web para control de Horas Extras.
 * @description Interfaz administrativa con capacidades de aprobaci√≥n:
 * - Visualizaci√≥n de turnos.
 * - Filtros avanzados.
 * - APROBACI√ìN DE HORAS EXTRAS (Supervisor y Director).
 * - ESTAD√çSTICAS: Total, Pendientes, Aprobados, En Sitio, Fuera.
 *
 * @features
 *   - üìä **Stats Box:** Contadores de registros y estados de aprobaci√≥n.
 *   - üìç **Ubicaci√≥n:** Tarjetas para contar cu√°ntos est√°n "En Sitio" vs "Fuera".
 *   - üö¶ **Columna Estado:** Visualiza si est√° Pendiente Supervisor, Director o Aprobado.
 *   - ‚úÖ **Aprobaci√≥n Integrada:** Botones para aprobar registros seg√∫n el rol del usuario.
 *
 * @author NASE Team
 * @version 2.4 (Log Eliminado + Orden Visual)
 ======================================================================= -->
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
  <title>NASE - Control Horas Extras</title> 
 
  <!-- Bootstrap + Fonts + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> 
 
  <!-- ======================================================================
   * üé® ESTILOS CSS
   * ====================================================================== -->
  <style>
    :root {
      --bg: #f6f8fb;
      --card: #fff;
      --primary: #0b6efd;
      --success: #198754;
      --text-color: #17365D;
      --warning-site: #0dcaf0; /* Color verde para "En Sitio" */
      --danger-site: #dc3545; /* Color rojo para "Fuera" */
    }
   
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: 'Poppins', Arial, Helvetica, sans-serif;
      background-color: var(--bg);
      font-size: 0.875rem;
    }
   
    .app-container {
      width: 100%;
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
    }
   
    .header {
      background: var(--card);
      padding: 15px 30px;
      border-bottom: 1px solid #e9ecef;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 25px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.02);
    }
    .logo { height: 70px; }
    .page-title {
      color: var(--text-color);
      font-weight: 600;
      font-size: 1.5rem;
      margin: 0;
      text-align: center;
      flex-grow: 1;
      padding: 0 20px;
    }
   
    /* Estilo de Estad√≠sticas (Stats Box) */
    .stats-box {
      background: white;
      padding: 15px;
      border-radius: 12px;
      text-align: center;
      border: 1px solid #f0f0f0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.03);
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .stats-num { font-size: 1.6rem; font-weight: 600; color: var(--text-color); line-height: 1.2; }
    .stats-label { color: #6c757d; font-size: 0.8rem; font-weight: 500; text-transform: uppercase; }

    .filters-card {
      background: var(--card);
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      border: 1px solid #f0f0f0;
    }
   
    .form-label {
      font-weight: 600;
      color: var(--text-color);
      font-size: 0.85rem;
      margin-bottom: 0.3rem;
    }
   
    .form-control, .form-select {
      border-radius: 8px;
      border: 1px solid #dee2e6;
      padding: 8px 12px;
      font-size: 0.9rem;
    }
   
    .form-control:focus, .form-select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(11,110,253,0.15);
    }
   
    .btn-custom {
      min-height: 46px;
      font-size: 0.9rem;
      font-weight: 500;
      border-radius: 10px;
      padding: 8px 20px;
      transition: all 0.2s;
    }
   
    .btn-primary-custom {
      background-color: var(--primary);
      border-color: var(--primary);
      color: white;
    }
   
    .btn-primary-custom:hover {
      background-color: #0a58ca;
      border-color: #0a58ca;
      transform: translateY(-1px);
    }
   
    .btn-success-custom {
      background-color: var(--success);
      border-color: var(--success);
      color: white;
    }
   
    .btn-success-custom:hover {
      background-color: #157347;
      border-color: #157347;
      transform: translateY(-1px);
    }

    /* Botones de Aprobaci√≥n Peque√±os */
    .btn-aprobar {
      font-size: 0.75rem;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .btn-aprobar-sup {
      background-color: #ffc107;
      color: #000;
    }
    .btn-aprobar-sup:hover { background-color: #e0a800; }
    
    .btn-aprobar-dir {
      background-color: #dc3545;
      color: #fff;
    }
    .btn-aprobar-dir:hover { background-color: #b02a37; }
   
    .table-container {
      max-height: 700px;
      overflow-y: auto;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      background: var(--card);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.03);
      margin-bottom: 20px;
      border: 1px solid #e9ecef;
    }

    .table {
      width: 100%;
      min-width: 1400px;
      border-collapse: collapse;
    }

    .table thead th {
      position: sticky;
      top: 0;
      z-index: 100;
      background-color: #f8f9fa;
      background-clip: padding-box;
      color: var(--text-color);
      font-weight: 600;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border: 1px solid #dee2e6;
      padding: 10px 8px;
      white-space: nowrap;
    }

    .table tbody td {
      padding: 10px 8px;
      vertical-align: middle;
      font-size: 0.85rem;
      border: 1px solid #f1f3f5;
      white-space: nowrap;
    }
   
    .table tbody tr:hover {
      background-color: #f8f9fa;
    }
   
    .foto-cell {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid #fff;
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
      transition: transform 0.2s;
      background: #eee;
    }
   
    .foto-cell:hover {
      transform: scale(1.25);
      z-index: 10;
      border-color: var(--primary);
    }
   
    .no-photo {
      width: 40px;
      height: 40px;
      background-color: #e9ecef;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6c757d;
      font-size: 18px;
    }
   
    .btn-ver-detalle {
      background: none;
      border: none;
      color: var(--primary);
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }
   
    .btn-ver-detalle:hover {
      background-color: #e7f1ff;
      transform: scale(1.1);
    }

    /* Badges de Estado */
    .badge-status {
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: inline-block;
    }
    .badge-pendiente-super { background-color: #ffc107; color: #000; }
    .badge-pendiente-dir { background-color: #dc3545; color: #fff; }
    .badge-aprobado { background-color: #198754; color: #fff; }
    .badge-incompleto { background-color: #6c757d; color: #fff; }
   
    /* Paginaci√≥n */
    .pagination-container {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }
   
    .pagination {
      display: flex;
      list-style: none;
      padding: 0;
      margin: 0;
    }
   
    .page-item {
      margin: 0 5px;
    }
   
    .page-link {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background-color: #fff;
      border: 1px solid #dee2e6;
      color: var(--primary);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
   
    .page-link:hover {
      background-color: #f8f9fa;
      transform: translateY(-2px);
    }
   
    .page-item.active .page-link {
      background-color: var(--primary);
      border-color: var(--primary);
      color: white;
    }
   
    .page-item.disabled .page-link {
      color: #6c757d;
      cursor: not-allowed;
    }
   
    .autocomplete-suggestions {
      position: absolute;
      border: 1px solid #ddd;
      background: white;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      display: none;
    }
    .autocomplete-suggestion {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    .autocomplete-suggestion:hover {
      background-color: #f8f9fa;
    }
    .autocomplete-suggestion:last-child {
      border-bottom: none;
    }
   
    /* ESTILOS DEL MODAL (CARDS) */
    .modal-card {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    .modal-card-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      color: var(--text-color);
      margin-bottom: 15px;
      border-bottom: 1px solid #e9ecef;
      padding-bottom: 10px;
    }
   
    @media (max-width: 768px) {
      .app-container { padding: 10px; }
      .header { padding: 10px 15px; }
      .page-title { font-size: 1.2rem; }
      .logo { height: 50px; }
      .filters-card, .table-container { padding: 15px; }
      .table thead th, .table tbody td { padding: 8px 6px; font-size: 12px; }
      .foto-cell, .no-photo { width: 30px; height: 30px; font-size: 14px; }
      .stats-box { padding: 10px; }
      .stats-num { font-size: 1.2rem; }
    }
  </style>
</head>

<!-- ======================================================================
 * üìê ESTRUCTURA HTML
 ====================================================================== -->
<body>
  <div class="app-container">

    <!-- 0. PANEL DE ESTAD√çSTICAS (Stats Box) -->
    <div class="row g-3 mb-4">
      <!-- 1. TOTAL -->
      <div class="col-6 col-md-2">
        <div class="stats-box">
          <div class="stats-num" id="statTotal">0</div>
          <div class="stats-label">Registros</div>
        </div>
      </div>
      <!-- 2. PENDIENTE SUPERVISOR -->
      <div class="col-6 col-md-2">
        <div class="stats-box">
          <div class="stats-num text-warning" id="statPendienteSup">0</div>
          <div class="stats-label">Pendiente Super</div>
        </div>
      </div>
      <!-- 3. PENDIENTE DIRECTOR -->
      <div class="col-6 col-md-2">
        <div class="stats-box">
          <div class="stats-num text-danger" id="statPendienteDir">0</div>
          <div class="stats-label">Pendiente Director</div>
        </div>
      </div>
      <!-- 4. APROBADO -->
      <div class="col-6 col-md-2">
        <div class="stats-box">
          <div class="stats-num text-success" id="statAprobado">0</div>
          <div class="stats-label">Aprobado</div>
        </div>
      </div>
      <!-- 5. EN SITIO -->
      <div class="col-6 col-md-2">
        <div class="stats-box">
          <div class="stats-num text-success" style="color: var(--warning-site) !important;" id="statEnSitio">0</div>
          <div class="stats-label">En Sitio</div>
        </div>
      </div>
      <!-- 6. FUERA -->
      <div class="col-6 col-md-2">
        <div class="stats-box">
          <div class="stats-num text-danger" style="color: var(--danger-site) !important;" id="statFuera">0</div>
          <div class="stats-label">Fuera</div>
        </div>
      </div>
    </div>

    <!-- 1. CABECERA -->
    <div class="header">
      <img src="https://raw.githubusercontent.com/jotalexvalencia/NASE/main/Logo_Nase.png" alt="NASE" class="logo">
      <h2 class="page-title">Control y Aprobaci√≥n de Horas Extras</h2>
      <div style="width: 80px;"></div>
    </div>
   
    <!-- 2. TARJETA DE FILTROS -->
    <div class="filters-card">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Fecha Inicio</label>
          <input type="date" id="fechaInicio" class="form-control">
        </div>
        <div class="col-md-3">
          <label class="form-label">Fecha Fin</label>
          <input type="date" id="fechaFin" class="form-control">
        </div>
        <div class="col-md-2">
          <label class="form-label">C√©dula</label>
          <input type="text" id="filtroCedula" class="form-control" placeholder="Buscar..." oninput="buscarAutocomplete('cedula')">
          <div id="autocompleteCedula" class="autocomplete-suggestions"></div>
        </div>
        <div class="col-md-2">
          <label class="form-label">Nombre</label>
          <input type="text" id="filtroNombre" class="form-control" placeholder="Buscar..." oninput="buscarAutocomplete('nombre')">
          <div id="autocompleteNombre" class="autocomplete-suggestions"></div>
        </div>
        <div class="col-md-2">
          <label class="form-label">Centro</label>
          <input type="text" id="filtroCentro" class="form-control" placeholder="Buscar..." oninput="buscarAutocomplete('centro')">
          <div id="autocompleteCentro" class="autocomplete-suggestions"></div>
        </div>
        <div class="col-md-12 d-flex justify-content-end mt-3 gap-2">
          <button class="btn btn-custom btn-primary-custom" onclick="filtrarRegistros()">
            <i class="bi bi-search me-2"></i>Filtrar
          </button>
          <button class="btn btn-custom btn-success-custom" onclick="exportarRegistros()">
            <i class="bi bi-file-earmark-excel me-2"></i>Exportar
          </button>
        </div>
      </div>
    </div>
   
    <!-- 3. TABLA DE REGISTROS -->
    <div class="table-container">
      <table class="table" id="tablaRegistros">
        <thead>
          <tr>
            <th>C√©dula</th>
            <th>Nombre</th>
            <th>Centro</th>
            <th>Ciudad</th>
            <th>F. Ent</th>
            <th>H. Ent</th>
            <th>Foto Ent</th>
            <th>F. Sal</th>
            <th>H. Sal</th>
            <th>Foto Sal</th>
            <th>Estado HE</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="cuerpoTabla">
          <tr>
            <td colspan="14" class="text-center py-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
              </div>
              <div class="mt-2 text-muted">Cargando datos...</div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
   
    <!-- 4. PAGINACI√ìN -->
    <div class="pagination-container">
      <ul class="pagination" id="paginacion"></ul>
    </div>
   
    <!-- 5. MODAL VISOR DE FOTOS -->
    <div id="photoModal" style="display:none;position:fixed;z-index:2000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.8);cursor:pointer;">
      <span style="position:absolute;top:20px;right:30px;color:#fff;font-size:40px;font-weight:bold;z-index:2001;" onclick="closePhotoModal()">&times;</span>
      <img style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);max-width:90%;max-height:90%;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.3);" id="modalImage">
    </div>
   
    <!-- 6. MODAL DETALLES (SOLO TARJETAS ENTRADA Y SALIDA - LOG ELIMINADO) -->
    <div id="detalleModal" style="display:none;position:fixed;z-index:2000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);overflow-y:auto;">
      <div style="background-color:#fff;margin:2% auto;padding:0;border-radius:16px;width:90%;max-width:900px;box-shadow:0 10px 40px rgba(0,0,0,0.2);overflow:hidden;">
        <div style="background:linear-gradient(135deg,var(--primary),#0a58ca);color:white;padding:16px 24px;display:flex;justify-content:space-between;align-items:center;">
          <h3 style="font-size:18px;font-weight:600;margin:0;">Detalles del Registro</h3>
          <button style="color:white;font-size:24px;font-weight:bold;background:none;border:none;opacity:0.8;" onclick="closeDetalleModal()">&times;</button>
        </div>
        <div style="padding:20px;">
          <div style="display:grid;grid-template-columns: 1fr 1fr; gap:20px;">
            
            <!-- TARJETA 1: ENTRADA -->
            <div class="modal-card">
              <div class="modal-card-title">
                <i class="bi bi-box-arrow-in-right text-success"></i> Entrada
              </div>
              
              <div style="display:flex;margin-bottom:8px;align-items:center;">
                <span style="font-weight:500;color:#6c757d;width:80px;font-size:13px;">Fecha:</span>
                <span style="color:#212529;font-size:13px;" id="detalleFechaEntrada">-</span>
              </div>
              <div style="display:flex;margin-bottom:8px;align-items:center;">
                <span style="font-weight:500;color:#6c757d;width:80px;font-size:13px;">Hora:</span>
                <span style="color:#212529;font-size:13px;" id="detalleHoraEntrada">-</span>
              </div>
              <div style="display:flex;margin-bottom:8px;align-items:center;">
                <span style="font-weight:500;color:#6c757d;width:80px;font-size:13px;">Centro:</span>
                <span style="color:#212529;font-size:13px;" id="detalleCentroEntrada">-</span>
              </div>
              <div style="display:flex;margin-bottom:8px;align-items:center;">
                <span style="font-weight:500;color:#6c757d;width:80px;font-size:13px;">Estado:</span>
                <span style="color:#212529;font-size:13px;" id="detalleDentroEntrada">-</span>
              </div>
              <!-- Foto Entrada -->
              <div style="display:flex;align-items:center;margin-bottom:8px;">
                <span style="font-weight:500;color:#6c757d;width:80px;font-size:13px;">Foto:</span>
                <div>
                  <img id="detalleFotoEntrada" style="width:80px;height:80px;object-fit:cover;border-radius:8px;cursor:pointer;box-shadow:0 2px 5px rgba(0,0,0,0.1);" onclick="openPhotoModal(this.src)">
                  <div id="detalleFotoEntradaVacia" class="no-photo" style="width:80px;height:80px;display:none;font-size:24px;">üì∑</div>
                </div>
              </div>
              <!-- Link Mapa Entrada -->
              <div style="text-align:center;margin-top:10px;">
                <a href="#" id="mapLinkEntrada" target="_blank" style="color:var(--primary);text-decoration:none;font-size:13px;">
                  <i class="bi bi-map"></i> Ver ubicaci√≥n entrada
                </a>
              </div>
            </div>

            <!-- TARJETA 2: SALIDA -->
            <div class="modal-card">
              <div class="modal-card-title">
                <i class="bi bi-box-arrow-left text-danger"></i> Salida
              </div>
              
              <div style="display:flex;margin-bottom:8px;align-items:center;">
                <span style="font-weight:500;color:#6c757d;width:80px;font-size:13px;">Fecha:</span>
                <span style="color:#212529;font-size:13px;" id="detalleFechaSalida">-</span>
              </div>
              <div style="display:flex;margin-bottom:8px;align-items:center;">
                <span style="font-weight:500;color:#6c757d;width:80px;font-size:13px;">Hora:</span>
                <span style="color:#212529;font-size:13px;" id="detalleHoraSalida">-</span>
              </div>
              <div style="display:flex;margin-bottom:8px;align-items:center;">
                <span style="font-weight:500;color:#6c757d;width:80px;font-size:13px;">Centro:</span>
                <span style="color:#212529;font-size:13px;" id="detalleCentroSalida">-</span>
              </div>
              <div style="display:flex;margin-bottom:8px;align-items:center;">
                <span style="font-weight:500;color:#6c757d;width:80px;font-size:13px;">Estado:</span>
                <span style="color:#212529;font-size:13px;" id="detalleDentroSalida">-</span>
              </div>
              <!-- Foto Salida -->
              <div style="display:flex;align-items:center;margin-bottom:8px;">
                <span style="font-weight:500;color:#6c757d;width:80px;font-size:13px;">Foto:</span>
                <div>
                  <img id="detalleFotoSalida" style="width:80px;height:80px;object-fit:cover;border-radius:8px;cursor:pointer;box-shadow:0 2px 5px rgba(0,0,0,0.1);" onclick="openPhotoModal(this.src)">
                  <div id="detalleFotoSalidaVacia" class="no-photo" style="width:80px;height:80px;display:none;font-size:24px;">üì∑</div>
                </div>
              </div>
              <!-- Link Mapa Salida -->
              <div style="text-align:center;margin-top:10px;">
                <a href="#" id="mapLinkSalida" target="_blank" style="color:var(--primary);text-decoration:none;font-size:13px;">
                  <i class="bi bi-map"></i> Ver ubicaci√≥n salida
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- ======================================================================
 * üß† L√ìGICA JAVASCRIPT (Frontend + Aprobaci√≥n + Stats)
 ====================================================================== -->
<script>
    let registrosData = [];
    let paginaActual = 1;
    const registrosPorPagina = 8; 
    let autocompleteTimeout = null;

    // Funci√≥n para convertir URL de Drive a Thumbnail
    function convertirUrlDrive(url) {
      if (!url) return '';
      const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
      if (match && match[1]) {
        return 'https://drive.google.com/thumbnail?id=' + match[1] + '&sz=s1000';
      }
      return url;
    }
   
    function formatoHora(hora) {
      if (!hora || hora === '-') return '-';
      const match = hora.match(/(\d{1,2}):(\d{2})/);
      if (match) {
        return `${String(parseInt(match[1], 10)).padStart(2, '0')}:${match[2]}`;
      }
      return '-';
    }

    function formatearFechaParaTabla(inputDate) {
      if (!inputDate) return '-';
      const str = String(inputDate);
      if (str.length === 10 && str.includes('/')) return str; 
      try {
        const date = new Date(inputDate);
        if (isNaN(date.getTime())) return str;
        const dia = String(date.getDate()).padStart(2, '0');
        const mes = String(date.getMonth() + 1).padStart(2, '0');
        const anio = date.getFullYear();
        return `${dia}/${mes}/${anio}`;
      } catch (e) { return '-'; }
    }

    // -------------------------------------------------------------------
    // 1. INICIALIZACI√ìN
    // -------------------------------------------------------------------
    document.addEventListener('DOMContentLoaded', function() {
      const hoy = new Date();
      const primerDiaMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
      const ultimoDiaMes = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);

      document.getElementById('fechaInicio').value = primerDiaMes.toISOString().split('T')[0];
      document.getElementById('fechaFin').value = ultimoDiaMes.toISOString().split('T')[0];

      cargarRegistros();
    });

    // -------------------------------------------------------------------
    // 2. OBTENER DATOS (Backend)
    // -------------------------------------------------------------------
    function cargarRegistros() {
      const filtros = {
          fechaInicio: document.getElementById('fechaInicio').value,
          fechaFin: document.getElementById('fechaFin').value,
          cedula: document.getElementById('filtroCedula').value,
          nombre: document.getElementById('filtroNombre').value,
          centro: document.getElementById('filtroCentro').value
      };

      document.getElementById('cuerpoTabla').innerHTML = `
        <tr><td colspan="14" class="text-center py-5">
          <div class="spinner-border text-primary" role="status"></div>
          <div class="mt-2 text-muted">Cargando datos...</div>
        </td></tr>
      `;

      google.script.run
        .withSuccessHandler(function(res) {
          if (res.status === 'ok') {
            registrosData = res.registros || [];
            paginaActual = 1;
            mostrarRegistros();
            actualizarEstadisticas();
          } else {
            document.getElementById('cuerpoTabla').innerHTML = `<tr><td colspan="14" class="text-center text-danger py-5">${res.message || 'Error desconocido'}</td></tr>`;
          }
        })
        .withFailureHandler(function(err) {
          document.getElementById('cuerpoTabla').innerHTML = `<tr><td colspan="14" class="text-center text-danger py-5">‚ùå Error de conexi√≥n: ${err.message}</td></tr>`;
        })
        .obtenerRegistros(filtros);
    }

    function filtrarRegistros() {
      paginaActual = 1;
      cargarRegistros();
    }

    // -------------------------------------------------------------------
    // 3. ACTUALIZAR ESTAD√çSTICAS (Contadores Actualizados)
    // -------------------------------------------------------------------
    function actualizarEstadisticas() {
      const total = registrosData.length;
      const pendienteSup = registrosData.filter(r => r.estadoHE === 'Pendiente Supervisor').length;
      const pendienteDir = registrosData.filter(r => r.estadoHE === 'Pendiente Director').length;
      const aprobado = registrosData.filter(r => r.estadoHE === 'Aprobado').length;
      
      const enSitio = registrosData.filter(r => ['s√≠', 'si'].includes(String(r.dentroCentro).toLowerCase())).length;
      const fuera = total - enSitio;

      document.getElementById('statTotal').textContent = total;
      document.getElementById('statPendienteSup').textContent = pendienteSup;
      document.getElementById('statPendienteDir').textContent = pendienteDir;
      document.getElementById('statAprobado').textContent = aprobado;
      document.getElementById('statEnSitio').textContent = enSitio;
      document.getElementById('statFuera').textContent = fuera;
    }

    // -------------------------------------------------------------------
    // 4. RENDERIZADO DE TABLA
    // -------------------------------------------------------------------
    function mostrarRegistros() {
      const tbody = document.getElementById('cuerpoTabla');
      if (!registrosData.length) {
        tbody.innerHTML = `<tr><td colspan="14" class="text-center py-5">No se encontraron registros</td></tr>`;
        document.getElementById('paginacion').innerHTML = '';
        return;
      }

      const inicio = (paginaActual - 1) * registrosPorPagina;
      const fin = inicio + registrosPorPagina;
      const pagina = registrosData.slice(inicio, fin);
      tbody.innerHTML = '';

      pagina.forEach((r, idx) => {
        const idxGlobal = inicio + idx;
        
        let fotoEnt = r.fotoEntrada || ''; 
        let fotoSal = r.fotoSalida || '';

        const urlEnt = convertirUrlDrive(fotoEnt);
        const urlSal = convertirUrlDrive(fotoSal);
        
        const dentro = ['s√≠', 'si'].includes(String(r.dentroCentro).toLowerCase());
        const dentroSal = ['s√≠', 'si'].includes(String(r.dentroCentroSal || '').toLowerCase());

        const fechaEntFormateada = formatearFechaParaTabla(r.timestamp); 
        const fechaSalFormateada = formatearFechaParaTabla(r.fechaSalida);

        // --- L√ìGICA DE BOTONES DE APROBACI√ìN ---
        let estadoBadge = '';
        let accionesHtml = '';

        const tieneSalida = r.fechaSalida && r.horaSalida;

        if (!tieneSalida) {
          estadoBadge = '<span class="badge-status badge-incompleto">Incompleto</span>';
          accionesHtml = '<button class="btn btn-sm btn-outline-secondary" disabled><i class="bi bi-lock"></i></button>';
        } else {
          const estado = r.estadoHE || ''; 

          if (estado === 'Pendiente Supervisor') {
            estadoBadge = '<span class="badge-status badge-pendiente-super">Pendiente Supervisor</span>';
            accionesHtml = `<button class="btn-aprobar btn-aprobar-sup" onclick="aprobarRegistro(${r.fila}, 'supervisor')"><i class="bi bi-check-circle-fill"></i> Aprobar (Sup)</button>`;
          } else if (estado === 'Pendiente Director') {
            estadoBadge = '<span class="badge-status badge-pendiente-dir">Pendiente Director</span>';
            accionesHtml = `<button class="btn-aprobar btn-aprobar-dir" onclick="aprobarRegistro(${r.fila}, 'director')"><i class="bi bi-shield-check"></i> Aprobar (Dir)</button>`;
          } else if (estado === 'Aprobado') {
            estadoBadge = '<span class="badge-status badge-aprobado">Aprobado</span>';
            accionesHtml = `<span style="color:#198754; font-weight:bold;"><i class="bi bi-check-circle"></i> Aprobado</span>`;
          } else {
            estadoBadge = '<span class="badge-status badge-pendiente-super">Pendiente Supervisor</span>';
            accionesHtml = `<button class="btn-aprobar btn-aprobar-sup" onclick="aprobarRegistro(${r.fila}, 'supervisor')"><i class="bi bi-check-circle-fill"></i> Aprobar (Sup)</button>`;
          }
        }

        const btnDetalle = `<button class="btn-ver-detalle" onclick="mostrarDetalle(${idxGlobal})"><i class="bi bi-eye-fill"></i></button>`;

        const row = `
          <tr>
            <td>${r.cedula}</td>
            <td>${r.nombre}</td>
            <td>${r.centro}</td>
            <td>${r.ciudad}</td>
            <td>${fechaEntFormateada}</td>
            <td>${formatoHora(r.horaEntrada)}</td>
            <td>${urlEnt ? `<img src="${urlEnt}" class="foto-cell" onclick="openPhotoModal('${urlEnt}')">` : '<div class="no-photo">üì∑</div>'}</td>
            <td>${fechaSalFormateada}</td>
            <td>${formatoHora(r.horaSalida)}</td>
            <td>${urlSal ? `<img src="${urlSal}" class="foto-cell" onclick="openPhotoModal('${urlSal}')">` : '<div class="no-photo">üì∑</div>'}</td>
            <td>${estadoBadge}</td>
            <td>
              <div class="d-flex gap-1 align-items-center">
                ${accionesHtml}
                ${btnDetalle}
              </div>
            </td>
          </tr>`;
        tbody.innerHTML += row;
      });

      actualizarPaginacion();
    }

    // -------------------------------------------------------------------
    // 5. FUNCI√ìN DE APROBACI√ìN (Solo env√≠a datos)
    // -------------------------------------------------------------------
    function aprobarRegistro(fila) {
      Swal.fire({
          title: 'Aprobando...',
          text: 'Validando permisos y procesando...',
          allowOutsideClick: false,
          didOpen: () => Swal.showLoading()
      });

      google.script.run
        .withSuccessHandler(function(res) {
          Swal.close();
          
          if (res.status === 'ok') {
            Swal.fire({
              icon: 'success',
              title: '¬°Aprobado!',
              text: res.message,
              timer: 1500,
              showConfirmButton: false
            }).then(() => {
               cargarRegistros();
            });
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Permiso Denegado',
              text: res.message,
              confirmButtonText: 'Entendido',
              confirmButtonColor: '#dc3545'
            });
          }
        })
        .withFailureHandler(function(err) {
          Swal.close();
          Swal.fire('Error', 'No se pudo conectar con el servidor.', 'error');
        })
        .aprobarHorasExtras(fila);
    }


    // -------------------------------------------------------------------
    // 6. PAGINACI√ìN
    // -------------------------------------------------------------------
    function actualizarPaginacion() {
      const total = Math.ceil(registrosData.length / registrosPorPagina);
      const ul = document.getElementById('paginacion');
      ul.innerHTML = '';

      const prev = document.createElement('li');
      prev.className = `page-item ${paginaActual === 1 ? 'disabled' : ''}`;
      prev.innerHTML = `<a class="page-link" href="#" onclick="cambiarPagina(${paginaActual - 1})">&laquo;</a>`;
      ul.appendChild(prev);

      for (let i = 1; i <= total; i++) {
        if (total <= 7 || (i === 1 || i === total || (i >= paginaActual - 1 && i <= paginaActual + 1))) {
          const li = document.createElement('li');
          li.className = `page-item ${i === paginaActual ? 'active' : ''}`;
          li.innerHTML = `<a class="page-link" href="#" onclick="cambiarPagina(${i})">${i}</a>`;
          ul.appendChild(li);
        } else if ((i === paginaActual - 2 || i === paginaActual + 2) && total > 7) {
          const li = document.createElement('li');
          li.className = 'page-item disabled';
          li.innerHTML = '<a class="page-link">...</a>';
          ul.appendChild(li);
        }
      }

      const next = document.createElement('li');
      next.className = `page-item ${paginaActual === total ? 'disabled' : ''}`;
      next.innerHTML = `<a class="page-link" href="#" onclick="cambiarPagina(${paginaActual + 1})">&raquo;</a>`;
      ul.appendChild(next);
    }

    function cambiarPagina(p) {
      const max = Math.ceil(registrosData.length / registrosPorPagina);
      if (p < 1 || p > max) return;
      paginaActual = p;
      mostrarRegistros();
    }

    // -------------------------------------------------------------------
    // 7. MODAL DE DETALLES (Log Eliminado)
    // -------------------------------------------------------------------
    function mostrarDetalle(idx) {
      const r = registrosData[idx];
      
      let fotoEnt = r.fotoEntrada || ''; 
      let fotoSal = r.fotoSalida || '';

      const urlEnt = convertirUrlDrive(fotoEnt);
      const urlSal = convertirUrlDrive(fotoSal);
      
      function formatearFecha(isoString) {
         if (!isoString) return '-';
         const str = String(isoString);
         if (str.length === 10 && str.includes('/')) return str;
         const d = new Date(isoString);
         if (isNaN(d.getTime())) return str;
         return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
      }

      // --- ENTRADA ---
      document.getElementById('detalleFechaEntrada').textContent = formatearFecha(r.timestamp);
      document.getElementById('detalleHoraEntrada').textContent = formatoHora(r.horaEntrada);
      document.getElementById('detalleCentroEntrada').textContent = r.centro || '-';
      
      const dentroEnt = ['s√≠', 'si'].includes(String(r.dentroCentro).toLowerCase());
      document.getElementById('detalleDentroEntrada').innerHTML =
        `<span class="badge badge-status ${dentroEnt ? 'bg-success' : 'bg-danger'}">${dentroEnt ? 'En Sitio' : 'Fuera'}</span>`;

      if (urlEnt) {
        document.getElementById('detalleFotoEntrada').src = urlEnt;
        document.getElementById('detalleFotoEntrada').style.display = 'block';
        document.getElementById('detalleFotoEntradaVacia').style.display = 'none';
      } else {
        document.getElementById('detalleFotoEntrada').style.display = 'none';
        document.getElementById('detalleFotoEntradaVacia').style.display = 'block';
      }

      if (r.lat && r.lng) {
        document.getElementById('mapLinkEntrada').href = `https://www.google.com/maps/search/?api=1&query=${r.lat},${r.lng}`;
        document.getElementById('mapLinkEntrada').style.display = 'block';
      } else {
        document.getElementById('mapLinkEntrada').style.display = 'none';
      }

      // --- SALIDA ---
      document.getElementById('detalleFechaSalida').textContent = formatearFecha(r.fechaSalida);
      document.getElementById('detalleHoraSalida').textContent = formatoHora(r.horaSalida);
      document.getElementById('detalleCentroSalida').textContent = r.centro || '-';
      
      const dentroSal = r.dentroCentroSal || '-';
      const esDentroSal = ['s√≠', 'si'].includes(String(dentroSal).toLowerCase());
      
      document.getElementById('detalleDentroSalida').innerHTML =
        `<span class="badge badge-status ${esDentroSal ? 'bg-success' : 'bg-danger'}">${esDentroSal ? 'En Sitio' : 'Fuera'}</span>`;

      if (urlSal) {
        document.getElementById('detalleFotoSalida').src = urlSal;
        document.getElementById('detalleFotoSalida').style.display = 'block';
        document.getElementById('detalleFotoSalidaVacia').style.display = 'none';
      } else {
        document.getElementById('detalleFotoSalida').style.display = 'none';
        document.getElementById('detalleFotoSalidaVacia').style.display = 'block';
      }

      if (r.lat && r.lng) {
        document.getElementById('mapLinkSalida').href = `https://www.google.com/maps/search/?api=1&query=${r.lat},${r.lng}`;
        document.getElementById('mapLinkSalida').style.display = 'block';
      } else {
        document.getElementById('mapLinkSalida').style.display = 'none';
      }

      document.getElementById('detalleModal').style.display = 'block';
    }

    function closeDetalleModal() {
      document.getElementById('detalleModal').style.display = 'none';
    }

    // -------------------------------------------------------------------
    // 8. VISOR DE FOTOS
    // -------------------------------------------------------------------
    function openPhotoModal(url) {
      document.getElementById('modalImage').src = url.replace('sz=s1000', 'sz=s1200');
      document.getElementById('photoModal').style.display = 'block';
    }

    function closePhotoModal() {
      document.getElementById('photoModal').style.display = 'none';
    }

    // -------------------------------------------------------------------
    // 9. EXPORTAR CSV
    // -------------------------------------------------------------------
    function exportarRegistros() {
      const filtros = {
          fechaInicio: document.getElementById('fechaInicio').value,
          fechaFin: document.getElementById('fechaFin').value,
          cedula: document.getElementById('filtroCedula').value,
          nombre: document.getElementById('filtroNombre').value,
          centro: document.getElementById('filtroCentro').value
      };

      Swal.fire({ title: 'Exportando...', didOpen: () => Swal.showLoading() });

      google.script.run
        .withSuccessHandler(function(res) {
          Swal.close();
          if (res.status === 'ok') {
            const blob = new Blob(["\ufeff", res.csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = res.filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            Swal.fire('√âxito', 'Archivo descargado.', 'success');
          } else {
            Swal.fire('Error', res.message || 'Error al exportar.', 'error');
          }
        })
        .withFailureHandler(function(err) {
          Swal.close();
          Swal.fire('Error', err.message, 'error');
        })
        .exportarRegistrosExcel(filtros);
    }

    // -------------------------------------------------------------------
    // 10. AUTOCOMPLETADO
    // -------------------------------------------------------------------
    function buscarAutocomplete(tipo) {
      clearTimeout(autocompleteTimeout);
      const input = document.getElementById(`filtro${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
      const suggestionsDiv = document.getElementById(`autocomplete${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
      const valor = input.value.trim();

      if (valor.length < 2) {
        suggestionsDiv.style.display = 'none';
        return;
      }

      autocompleteTimeout = setTimeout(() => {
        google.script.run
          .withSuccessHandler(suggestions => {
            if (suggestions && suggestions.length > 0) {
              suggestionsDiv.innerHTML = suggestions.map(s => `
                <div class="autocomplete-suggestion" onclick="seleccionarSugerencia('${tipo}', '${s}')">${s}</div>
              `).join('');
              suggestionsDiv.style.display = 'block';
            } else {
              suggestionsDiv.style.display = 'none';
            }
          })
          .withFailureHandler(() => {
            suggestionsDiv.style.display = 'none';
          })
          .obtenerSugerencias(valor, tipo);
      }, 300);
    }

    function seleccionarSugerencia(tipo, valor) {
      document.getElementById(`filtro${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`).value = valor;
      document.getElementById(`autocomplete${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`).style.display = 'none';
      filtrarRegistros();
    }

    document.addEventListener('click', function(e) {
      const inputs = ['filtroCedula', 'filtroNombre', 'filtroCentro'];
      const suggestions = ['autocompleteCedula', 'autocompleteNombre', 'autocompleteCentro'];
      
      if (!inputs.some(id => e.target.id === id)) {
        suggestions.forEach(id => {
          document.getElementById(id).style.display = 'none';
        });
      }
    });
  </script>
</body>
</html>
