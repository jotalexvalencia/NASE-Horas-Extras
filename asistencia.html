<!DOCTYPE html>
<!-- =======================================================================
 * ðŸ“„ asistencia.html â€“ Frontend de Reportes de Asistencia (NASE 2026)
 * ----------------------------------------------------------------------
 * @summary Dashboard web para liquidaciÃ³n de Horas Extras y Asistencia.
 * @description 
 * Este archivo es la interfaz administrativa para visualizar
 * los datos calculados por `hoja_turnos.gs` (mÃ³dulo `generarTablaAsistenciaSinValores`).
 * 
 * @features
 *   - ðŸ“Š **EstadÃ­sticas:** Muestra totales de Horas Trabajadas, Nocturnas y Dominicales.
 *   - ðŸ“‹ **Tabla Paginada:** Presenta turnos con desglose de horas calculadas.
 *   - ðŸ§® **Desglose Horario:**
 *       * Horas Diurnas Normales.
 *       * Horas Nocturnas Normales.
 *       * Horas Diurnas Domingo/Festivo.
 *       * Horas Nocturnas Domingo/Festivo.
 *   - ðŸ§® **Rango Visual:** Columna "Rango Turno" que muestra la fecha/hora completa
 *       (Ej: "24/12/2025 21:00 - 25/12/2025 05:00").
 *   - ðŸ’¾ **Exportar CSV:** Descarga el reporte filtrado compatible con Excel.
 *
 * @dependencies
 *   - Backend: `hoja_turnos.gs` (Funciones `obtenerDataAsistencia`, `exportarAsistenciaCSV`).
 *   - LibrerÃ­as: Bootstrap 5 (Estilo), SweetAlert2 (Alertas), Bootstrap Icons.
 *
 * @author NASE Team
 * @version 2.0 (VisualizaciÃ³n de Horas Extras)
 ======================================================================= -->

<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
  <title>NASE - Reporte Asistencia</title> 
 
  <!-- Bootstrap + Fonts + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> 
 
  <!-- ======================================================================
   * ðŸŽ¨ ESTILOS CSS (DiseÃ±o Visual)
   * ====================================================================== -->
  <style>
    :root {
      --bg: #f6f8fb;
      --card: #fff;
      --primary: #0b6efd;
      --success: #198754;
      --text-color: #17365D;
    }
   
    html, body {
      margin:0;
      padding:0;
      width: 100%;
      height: 100%;
      font-family: 'Poppins', Arial, Helvetica, sans-serif;
      background-color: var(--bg);
      font-size: 0.875rem;
    }
   
    .app-container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
   
    .header {
      background: var(--card);
      padding: 15px 30px;
      border-bottom:1px solid #e9ecef;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 25px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.02);
    }
    .logo { height: 80px; }
    .page-title {
      color: var(--text-color);
      font-weight: 600;
      font-size: 1.5rem;
      margin: 0;
      text-align: center;
      flex-grow: 1;
      padding: 0 20px;
    }
   
    .filters-card {
      background: var(--card);
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      border: 1px solid #f0f0f0;
    }
   
    .form-label {
      font-weight: 600;
      color: var(--text-color);
      font-size: 0.85rem;
      margin-bottom: 0.3rem;
    }
   
    .form-control, .form-select {
      border-radius: 8px;
      border: 1px solid #dee2e6;
      padding: 8px 12px;
      font-size: 0.9rem;
    }
   
    .form-control:focus, .form-select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(11,110,253,0.15);
    }
   
    .btn-custom {
      min-height: 46px;
      font-size: 0.9rem;
      font-weight: 500;
      border-radius: 10px;
      padding: 8px 20px;
      transition: all 0.2s;
    }
   
    .btn-primary-custom {
      background-color: var(--primary);
      border-color: var(--primary);
      color: white;
    }
   
    .btn-primary-custom:hover {
      background-color: #0a58ca;
      border-color: #0a58ca;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(13, 110, 253, 0.25);
    }
   
    .btn-success-custom {
      background-color: var(--success);
      border-color: var(--success);
      color: white;
    }
   
    .btn-success-custom:hover {
      background-color: #157347;
      border-color: #157347;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(25, 135, 84, 0.25);
    }
   
    .table-container {
      max-height: 600px;
      overflow-y: auto;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      background: var(--card);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.03);
      margin-bottom: 20px;
      border: 1px solid #e9ecef;
      transform: none !important;
      filter: none !important;
      will-change: auto !important;
    }

    .table {
      width: 100%;
      min-width: 1400px; /* Asegura que la tabla no se encoje demasiado */
      border-collapse: collapse;
    }

    .table thead th {
      position: sticky;
      top: 0;
      z-index: 100;
      background-color: #f8f9fa;
      background-clip: padding-box;
      color: var(--text-color);
      font-weight: 600;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border: 1px solid #dee2e6;
      padding: 10px;
      white-space: nowrap;
    }

    .table tbody td {
      padding: 10px;
      vertical-align: middle;
      font-size: 0.85rem;
      border: 1px solid #f1f3f5;
      white-space: nowrap;
    }
   
    .table tbody tr:hover {
      background-color: #f8f9fa;
    }
   
    .text-center-cell {
      text-align: center !important;
    }
   
    .stats-box {
      background: white;
      padding: 15px;
      border-radius: 12px;
      text-align: center;
      border: 1px solid #f0f0f0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.03);
      height: 100%;
    }
    .stats-num { font-size: 1.6rem; font-weight: 600; color: var(--text-color); line-height: 1.2; }
    .stats-label { color: #6c757d; font-size: 0.8rem; font-weight: 500; text-transform: uppercase; }
   
    .pagination-container {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }
   
    .pagination {
      display: flex;
      list-style: none;
      padding: 0;
      margin: 0;
    }
   
    .page-item {
      margin: 0 5px;
    }
   
    .page-link {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background-color: #fff;
      border: 1px solid #dee2e6;
      color: var(--primary);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
   
    .page-link:hover {
      background-color: #f8f9fa;
      transform: translateY(-2px);
    }
   
    .page-item.active .page-link {
      background-color: var(--primary);
      border-color: var(--primary);
      color: white;
    }
   
    .page-item.disabled .page-link {
      color: #6c757d;
      cursor: not-allowed;
    }
   
    .autocomplete-suggestions {
      position: absolute;
      border: 1px solid #ddd;
      background: white;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      display: none;
    }
    .autocomplete-suggestion {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    .autocomplete-suggestion:hover {
      background-color: #f8f9fa;
    }
    .autocomplete-suggestion:last-child {
      border-bottom: none;
    }
   
    @media (max-width: 768px) {
      .app-container { padding: 10px; }
      .header { padding: 10px 15px; }
      .page-title { font-size: 1.2rem; }
      .logo { height: 60px; }
      .filters-card, .table-container { padding: 15px; }
      .table thead th, .table tbody td { padding: 8px 6px; font-size: 12px; }
    }
  </style>
</head>

<!-- ======================================================================
 * ðŸ“ ESTRUCTURA HTML (DOM)
 ====================================================================== -->
<body>
  <div class="app-container">
    <!-- 1. CABECERA -->
    <div class="header">
      <img src="https://raw.githubusercontent.com/jotalexvalencia/NASE/main/Logo_Nase.png" alt="NASE" class="logo">
      <h2 class="page-title">Reporte de Asistencia (Horas Extras)</h2>
      <div style="width: 80px;"></div>
    </div>
   
    <!-- 2. ðŸ“Š TARJETA DE ESTADÃSTICAS -->
    <div class="row g-3 mb-4">
      <div class="col-6 col-md-3">
        <div class="stats-box">
          <div class="stats-num" id="statRegistros">0</div>
          <div class="stats-label">Registros</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stats-box">
          <div class="stats-num text-primary" id="statHorasTotal">0</div>
          <div class="stats-label">Horas Totales</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stats-box">
          <div class="stats-num text-dark" id="statHorasNoc">0</div>
          <div class="stats-label">Horas con Recargo (Noc)</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stats-box">
          <div class="stats-num text-warning" id="statHorasFest">0</div>
          <div class="stats-label">Horas Dominicales</div>
        </div>
      </div>
    </div>
   
    <!-- 3. TARJETA DE FILTROS -->
    <div class="filters-card">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Fecha Inicio</label>
          <input type="date" id="filtroFechaInicio" class="form-control">
        </div>
        <div class="col-md-3">
          <label class="form-label">Fecha Fin</label>
          <input type="date" id="filtroFechaFin" class="form-control">
        </div>
        <div class="col-md-3">
          <label class="form-label">CÃ©dula</label>
          <input type="text" id="filtroCedula" class="form-control" placeholder="Buscar..." oninput="buscarAutocomplete('cedula')">
          <div id="autocompleteCedula" class="autocomplete-suggestions"></div>
        </div>
        <div class="col-md-3">
          <label class="form-label">Nombre</label>
          <input type="text" id="filtroNombre" class="form-control" placeholder="Buscar..." oninput="buscarAutocomplete('nombre')">
          <div id="autocompleteNombre" class="autocomplete-suggestions"></div>
        </div>
        
        <!-- Filtro Tipo DÃ­a -->
        <div class="col-md-2">
          <label class="form-label">Tipo DÃ­a</label>
          <select id="filtroTipoDia" class="form-select">
            <option value="">Todos</option>
            <option value="Normal">Normal</option>
            <option value="Domingo">Domingo</option>
            <option value="Festivo">Festivo</option>
          </select>
        </div>

        <div class="col-md-12 d-flex justify-content-end mt-3 gap-2">
          <button class="btn btn-custom btn-primary-custom" onclick="cargarDatosServidor()">
            <i class="bi bi-search me-2"></i>Consultar
          </button>
          <button class="btn btn-custom btn-success-custom" onclick="exportarDatos()">
            <i class="bi bi-file-earmark-excel me-2"></i>Exportar
          </button>
        </div>
      </div>
    </div>
   
    <!-- 4. TABLA DE REGISTROS -->
    <div class="table-container">
      <table class="table" id="tablaRegistros">
        <thead>
          <tr>
            <th>CÃ©dula</th>
            <th>Nombre Empleado</th>
            <th>Fecha</th>
            <th>Rango Turno & Centro</th>
            <th>Tipo DÃ­a<br><small>(Inicio / Fin)</small></th>
            <th>TOTAL<br>HORAS</th>
            <th>Turno<br>Diurno</th>
            <th>Turno<br>Nocturno</th>
            <th>Dominical<br>Diurno</th>
            <th>Dominical<br>Nocturno</th>
          </tr>
        </thead>
        <tbody id="cuerpoTabla">
          <tr>
            <td colspan="11" class="text-center py-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
              </div>
              <div class="mt-2 text-muted">Cargando datos...</div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
   
    <!-- 5. PAGINACIÃ“N -->
    <div class="pagination-container">
      <ul class="pagination" id="paginacion"></ul>
    </div>
  </div>


<!-- ======================================================================
 * ðŸ§  LÃ“GICA JAVASCRIPT (Frontend)
 ====================================================================== -->
  <script>
    let registrosData = [];
    let paginaActual = 1;
    const registrosPorPagina = 8;
    let autocompleteTimeout = null;

    // -------------------------------------------------------------------
    // 1. INICIALIZACIÃ“N
    // -------------------------------------------------------------------
    document.addEventListener('DOMContentLoaded', function() {
      const hoy = new Date();
      const primerDiaMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
      const ultimoDiaMes = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);

      document.getElementById('filtroFechaInicio').value = primerDiaMes.toISOString().split('T')[0];
      document.getElementById('filtroFechaFin').value = ultimoDiaMes.toISOString().split('T')[0];

      cargarDatosServidor();
    });

    // -------------------------------------------------------------------
    // 2. OBTENER DATOS (Backend Interaction)
    // -------------------------------------------------------------------
    function cargarDatosServidor() {
      const filtros = {
        fechaInicio: document.getElementById('filtroFechaInicio').value,
        fechaFin: document.getElementById('filtroFechaFin').value,
        cedula: document.getElementById('filtroCedula').value,
        nombre: document.getElementById('filtroNombre').value,
        tipoDia: document.getElementById('filtroTipoDia').value
      };

      document.getElementById('cuerpoTabla').innerHTML = `
        <tr><td colspan="11" class="text-center py-5">
          <div class="spinner-border text-primary" role="status"></div>
          <div class="mt-2 text-muted">Cargando...</div>
        </td></tr>
      `;

      google.script.run
        .withSuccessHandler(function(res) {
          if (res.status === 'ok') {
            registrosData = res.registros || [];
            // Nota: El backend ya devuelve los totales calculados, solo mostramos
            paginaActual = 1;
            mostrarRegistros();
            actualizarEstadisticas();
          } else {
            document.getElementById('cuerpoTabla').innerHTML = `<tr><td colspan="11" class="text-center text-danger py-5">${res.message || 'Error desconocido'}</td></tr>`;
            resetEstadisticas();
          }
        })
        .withFailureHandler(function(err) {
          document.getElementById('cuerpoTabla').innerHTML = `<tr><td colspan="11" class="text-center text-danger py-5">Error: ${err.message || 'No se pudo conectar'}</td></tr>`;
          resetEstadisticas();
        })
        .obtenerDataAsistencia(filtros);
    }

    function resetEstadisticas() {
      document.getElementById('statRegistros').textContent = '0';
      document.getElementById('statHorasTotal').textContent = '0';
      document.getElementById('statHorasNoc').textContent = '0';
      document.getElementById('statHorasFest').textContent = '0';
    }

    // -------------------------------------------------------------------
    // 3. ESTADÃSTICAS
    // -------------------------------------------------------------------
    function actualizarEstadisticas() {
      const total = registrosData.length;
      const totalHoras = registrosData.reduce((a,b) => a + b.horasTotal, 0);
      const horasNoc = registrosData.reduce((a,b) => a + b.hNocNorm + b.hNocFest, 0);
      const horasFest = registrosData.reduce((a,b) => a + b.hDiurFest + b.hNocFest, 0);
      
      document.getElementById('statRegistros').textContent = total;
      document.getElementById('statHorasTotal').textContent = totalHoras.toFixed(1);
      document.getElementById('statHorasNoc').textContent = horasNoc.toFixed(1);
      document.getElementById('statHorasFest').textContent = horasFest.toFixed(1);
    }

    // -------------------------------------------------------------------
    // 4. RENDERIZADO DE TABLA
    // -------------------------------------------------------------------
    function mostrarRegistros() {
      const tbody = document.getElementById('cuerpoTabla');
      if (!registrosData.length) {
        tbody.innerHTML = `<tr><td colspan="11" class="text-center py-5">No se encontraron registros</td></tr>`;
        document.getElementById('paginacion').innerHTML = '';
        return;
      }

      const inicio = (paginaActual - 1) * registrosPorPagina;
      const fin = inicio + registrosPorPagina;
      const pagina = registrosData.slice(inicio, fin);
      tbody.innerHTML = '';

      pagina.forEach(r => {
        const row = `
          <tr>
            <td class="fw-bold text-center-cell">${r.cedula}</td>
            <td>${r.nombre}</td>
            <td class="text-center-cell">${formatearFechaSeguro(r.fecha)}</td>
            <!-- Columna Visual Rango: Usa 'turnosDetalle' (Ej: "24/12/2025 21:00 - 25/12/2025 05:00") -->
            <td class="text-center-cell small">
                <div>${r.turnosDetalle}</div>
                <strong style="color:#0b6efd; display:block; margin-top:4px;">${r.centro}</strong>
            </td>
            <td class="text-center-cell small">
              <div class="fw-bold">${r.tipoDiaInicio}</div>
              <div class="text-muted" style="font-size:0.7em">a</div>
              <div class="fw-bold">${r.tipoDiaFin}</div>
            </td>
            <td class="text-center-cell">${r.horasTotal}</td>
            <td class="text-center-cell">${r.hDiurNorm}</td>
            <td class="text-center-cell">${r.hNocNorm}</td>
            <td class="text-center-cell">${r.hDiurFest}</td>
            <td class="text-center-cell">${r.hNocFest}</td>
          </tr>`;
        tbody.innerHTML += row;
      });

      actualizarPaginacion();
    }

    function actualizarPaginacion() {
      const total = Math.ceil(registrosData.length / registrosPorPagina);
      const ul = document.getElementById('paginacion');
      ul.innerHTML = '';

      const prev = document.createElement('li');
      prev.className = `page-item ${paginaActual === 1 ? 'disabled' : ''}`;
      prev.innerHTML = `<a class="page-link" href="#" onclick="cambiarPagina(${paginaActual - 1})">&laquo;</a>`;
      ul.appendChild(prev);

      for (let i = 1; i <= total; i++) {
        if (total <= 7 || (i === 1 || i === total || (i >= paginaActual - 1 && i <= paginaActual + 1))) {
          const li = document.createElement('li');
          li.className = `page-item ${i === paginaActual ? 'active' : ''}`;
          li.innerHTML = `<a class="page-link" href="#" onclick="cambiarPagina(${i})">${i}</a>`;
          ul.appendChild(li);
        } else if ((i === paginaActual - 2 || i === paginaActual + 2) && total > 7) {
          const li = document.createElement('li');
          li.className = 'page-item disabled';
          li.innerHTML = '<a class="page-link">...</a>';
          ul.appendChild(li);
        }
      }

      const next = document.createElement('li');
      next.className = `page-item ${paginaActual === total ? 'disabled' : ''}`;
      next.innerHTML = `<a class="page-link" href="#" onclick="cambiarPagina(${paginaActual + 1})">&raquo;</a>`;
      ul.appendChild(next);
    }

    function cambiarPagina(p) {
      const max = Math.ceil(registrosData.length / registrosPorPagina);
      if (p < 1 || p > max) return;
      paginaActual = p;
      mostrarRegistros();
    }

    // -------------------------------------------------------------------
    // 5. EXPORTAR A CSV
    // -------------------------------------------------------------------
    function exportarDatos() {
      const filtros = {
        fechaInicio: document.getElementById('filtroFechaInicio').value,
        fechaFin: document.getElementById('filtroFechaFin').value,
        cedula: document.getElementById('filtroCedula').value,
        nombre: document.getElementById('filtroNombre').value,
        tipoDia: document.getElementById('filtroTipoDia').value // âœ… LÃNEA INCLUIDA
      };

      Swal.fire({ title: 'Exportando...', didOpen: () => Swal.showLoading() });

      google.script.run
        .withSuccessHandler(function(res) {
          Swal.close();
          if (res.status === 'ok') {
            const blob = new Blob(["\ufeff", res.csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = res.filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            Swal.fire('Ã‰xito', 'Archivo descargado.', 'success');
          } else {
            Swal.fire('Error', res.message || 'Error al exportar.', 'error');
          }
        })
        .withFailureHandler(function(err) {
          Swal.close();
          Swal.fire('Error', err.message, 'error');
        })
        .exportarAsistenciaCSV(filtros);
    }

    // -------------------------------------------------------------------
    // 6. AUTOCOMPLETADO
    // -------------------------------------------------------------------
    function buscarAutocomplete(tipo) {
      clearTimeout(autocompleteTimeout);
      const input = document.getElementById(`filtro${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
      const suggestionsDiv = document.getElementById(`autocomplete${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
      const valor = input.value.trim();

      if (valor.length < 2) {
        suggestionsDiv.style.display = 'none';
        return;
      }

      autocompleteTimeout = setTimeout(() => {
        google.script.run
          .withSuccessHandler(suggestions => {
            if (suggestions && suggestions.length > 0) {
              suggestionsDiv.innerHTML = suggestions.map(s => `
                <div class="autocomplete-suggestion" onclick="seleccionarSugerencia('${tipo}', '${s}')">${s}</div>
              `).join('');
              suggestionsDiv.style.display = 'block';
            } else {
              suggestionsDiv.style.display = 'none';
            }
          })
          .withFailureHandler(() => {
            suggestionsDiv.style.display = 'none';
          })
          .obtenerSugerencias(valor, tipo);
      }, 300);
    }

    function seleccionarSugerencia(tipo, valor) {
      document.getElementById(`filtro${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`).value = valor;
      document.getElementById(`autocomplete${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`).style.display = 'none';
      cargarDatosServidor();
    }

    function formatearFechaSeguro(inputDate) {
      if (!inputDate) return '-';
      const str = String(inputDate);
      if (str.length === 10 && str.includes('/')) return str; // dd/mm/yyyy
      try {
        const date = new Date(inputDate);
        if (isNaN(date.getTime())) return str;
        return `${String(date.getDate()).padStart(2,'0')}/${String(date.getMonth()+1).padStart(2,'0')}/${date.getFullYear()}`;
      } catch (e) { return '-'; }
    }
  </script>
</body>
</html>
